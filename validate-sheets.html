<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Valida√ß√£o Google Sheets</title>
  <style>
    body {
      font-family: monospace;
      max-width: 900px;
      margin: 20px auto;
      padding: 20px;
      background: #1e1e1e;
      color: #d4d4d4;
    }
    
    h1 {
      color: #4CAF50;
    }
    
    .step {
      background: #2d2d2d;
      padding: 15px;
      margin: 10px 0;
      border-left: 4px solid #888;
      border-radius: 4px;
    }
    
    .step.success {
      border-left-color: #4CAF50;
    }
    
    .step.error {
      border-left-color: #f44336;
    }
    
    .step.warning {
      border-left-color: #ff9800;
    }
    
    .step.info {
      border-left-color: #2196F3;
    }
    
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 4px;
      cursor: pointer;
      margin: 10px 0;
    }
    
    button:hover {
      background: #45a049;
    }
    
    code {
      background: #1e1e1e;
      padding: 2px 6px;
      border-radius: 3px;
      color: #ce9178;
    }
    
    pre {
      background: #1e1e1e;
      padding: 10px;
      overflow-x: auto;
      border-radius: 4px;
    }
    
    .icon {
      font-size: 20px;
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <h1>üîç Valida√ß√£o da Integra√ß√£o Google Sheets</h1>
  
  <button onclick="runValidation()">‚ñ∂Ô∏è Executar Valida√ß√£o</button>
  
  <div id="results"></div>
  
  <script>
    const SHEET_ID = '1GQUB52a2gKR429bjqJrNkbP5rjR7Z_4v85z9M7_Cr8Y';
    const SHEET_NAME = 'PS1';
    const results = document.getElementById('results');
    
    function addStep(message, type = 'info', details = null) {
      const icons = {
        success: '‚úÖ',
        error: '‚ùå',
        warning: '‚ö†Ô∏è',
        info: '‚ÑπÔ∏è'
      };
      
      const step = document.createElement('div');
      step.className = `step ${type}`;
      step.innerHTML = `
        <span class="icon">${icons[type]}</span>
        <strong>${message}</strong>
        ${details ? `<pre>${details}</pre>` : ''}
      `;
      results.appendChild(step);
      
      // Scroll to bottom
      step.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
    
    async function runValidation() {
      results.innerHTML = '';
      
      addStep('Iniciando valida√ß√£o...', 'info');
      
      // 1. Verificar se o script googleSheets.js est√° carregado
      try {
        addStep('Verificando scripts necess√°rios...', 'info');
        
        if (typeof loadGoogleSheetData !== 'function') {
          addStep('Script googleSheets.js n√£o encontrado!', 'error', 
            'Certifique-se de que assets/data/googleSheets.js existe e est√° sendo carregado.');
          return;
        }
        
        addStep('Script googleSheets.js encontrado', 'success');
      } catch (error) {
        addStep('Erro ao verificar scripts', 'error', error.toString());
        return;
      }
      
      // 2. Verificar acessibilidade da planilha
      try {
        addStep('Verificando acessibilidade da planilha...', 'info');
        
        const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${SHEET_NAME}`;
        addStep('URL de acesso:', 'info', url);
        
        const response = await fetch(url);
        
        if (!response.ok) {
          addStep(`Erro HTTP ${response.status}: ${response.statusText}`, 'error',
            'A planilha pode n√£o estar p√∫blica ou o ID/nome do separador est√° incorreto.');
          return;
        }
        
        addStep('Planilha acess√≠vel via HTTP', 'success');
        
        const text = await response.text();
        
        if (!text.includes('google.visualization.Query.setResponse')) {
          addStep('Resposta da API n√£o est√° no formato esperado', 'error', text.substring(0, 200));
          return;
        }
        
        addStep('Formato de resposta v√°lido', 'success');
        
      } catch (error) {
        addStep('Erro ao acessar planilha', 'error', 
          error.toString() + '\n\nPoss√≠veis causas:\n' +
          '- Planilha n√£o est√° p√∫blica\n' +
          '- Bloqueio de CORS\n' +
          '- Sem conex√£o √† internet');
        return;
      }
      
      // 3. Carregar dados brutos
      let rawData;
      try {
        addStep('Carregando dados brutos...', 'info');
        
        rawData = await loadGoogleSheetData();
        
        if (!rawData || !Array.isArray(rawData)) {
          addStep('Dados inv√°lidos retornados', 'error', typeof rawData);
          return;
        }
        
        if (rawData.length === 0) {
          addStep('Nenhuma linha encontrada na planilha', 'warning', 
            'Verifique se o separador PS1 cont√©m dados.');
          return;
        }
        
        addStep(`${rawData.length} linhas carregadas`, 'success');
        
        // Mostrar primeira linha como exemplo
        addStep('Primeira linha:', 'info', JSON.stringify(rawData[0], null, 2));
        
      } catch (error) {
        addStep('Erro ao carregar dados brutos', 'error', error.toString());
        return;
      }
      
      // 4. Validar estrutura dos dados
      try {
        addStep('Validando estrutura dos dados...', 'info');
        
        const firstRow = rawData[0];
        const columns = Object.keys(firstRow);
        
        addStep(`Colunas encontradas: ${columns.join(', ')}`, 'info');
        
        // Verificar colunas obrigat√≥rias
        const hasNameCol = columns.some(col => 
          /^(name|nome|cidade|city|pa√≠s|country|location)$/i.test(col.trim())
        );
        
        const hasLatCol = columns.some(col => 
          /^(lat|latitude|latitud)$/i.test(col.trim())
        );
        
        const hasLonCol = columns.some(col => 
          /^(lon|lng|longitude|longitud)$/i.test(col.trim())
        );
        
        if (!hasNameCol) {
          addStep('Coluna de NOME n√£o encontrada', 'error', 
            'Esperado: name, nome, cidade, city, pa√≠s, country ou location');
        } else {
          addStep('Coluna de NOME encontrada', 'success');
        }
        
        if (!hasLatCol) {
          addStep('Coluna de LATITUDE n√£o encontrada', 'error', 
            'Esperado: lat, latitude ou latitud');
        } else {
          addStep('Coluna de LATITUDE encontrada', 'success');
        }
        
        if (!hasLonCol) {
          addStep('Coluna de LONGITUDE n√£o encontrada', 'error', 
            'Esperado: lon, lng, longitude ou longitud');
        } else {
          addStep('Coluna de LONGITUDE encontrada', 'success');
        }
        
        if (!hasNameCol || !hasLatCol || !hasLonCol) {
          addStep('Estrutura inv√°lida - faltam colunas obrigat√≥rias', 'error');
          return;
        }
        
      } catch (error) {
        addStep('Erro ao validar estrutura', 'error', error.toString());
        return;
      }
      
      // 5. Converter dados
      try {
        addStep('Convertendo dados para formato da aplica√ß√£o...', 'info');
        
        const { countries, connections } = convertSheetDataToAppFormat(rawData);
        
        if (!countries || countries.length === 0) {
          addStep('Nenhum pa√≠s foi convertido', 'warning', 
            'Verifique se os dados t√™m valores v√°lidos em todas as colunas obrigat√≥rias.');
          return;
        }
        
        addStep(`${countries.length} pa√≠ses convertidos`, 'success');
        addStep(`${Object.keys(connections).length} conex√µes encontradas`, 'info');
        
        // Mostrar alguns pa√≠ses como exemplo
        const sample = countries.slice(0, 3).map(c => 
          `${c.name} (${c.latitude}, ${c.longitude})`
        ).join('\n');
        
        addStep('Exemplos de pa√≠ses:', 'info', sample);
        
      } catch (error) {
        addStep('Erro ao converter dados', 'error', error.toString());
        return;
      }
      
      // 6. Conclus√£o
      addStep('‚ú® Valida√ß√£o conclu√≠da com sucesso!', 'success', 
        'A integra√ß√£o est√° funcionando corretamente.\n' +
        'Pode abrir index.html para ver o globo com os dados do Google Sheets.');
    }
  </script>
  
  <script src="assets/data/googleSheets.js"></script>
</body>
</html>
